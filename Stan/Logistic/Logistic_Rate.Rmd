---
title: "Logistic"
author: "Brynjólfur Gauti Jónsson"
date: "3/17/2020"
output: 
    html_document:
        theme: flatly
        code_folding: hide
runtime: shiny_prerendered
---

```{r setup, context = "setup", include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, 
                      fig.asp = 0.621, out.width = "100%", fig.width = 8)

library(tidyverse); library(knitr); library(kableExtra); library(broom); library(cowplot); 
library(rstan); library(tidybayes); library(scales)

theme_set(theme_classic(base_size = 12) + 
              background_grid(color.major = "grey90", 
                              color.minor = "grey95", 
                              minor = "xy", major = "xy") +
              theme(legend.position = "none"))
options(mc.cores = parallel::detectCores())
```


# Gögn

## Lönd

```{r, context = "data"}
d <- read_csv("https://www.dropbox.com/s/br9kjy0pbrzscq3/ECDC_Data.csv?dl=1") %>% 
    filter(case_rate > 0.01, 
           !country %in% c("China", "Hubei")) %>% 
    select(country, pop, date, days, cases = cum_cases, case_rate) %>% 
    group_by(country) %>% 
    mutate(days = row_number() - 1) %>% 
    filter(any(days > 10)) %>% 
    ungroup %>% 
    mutate(country_id = as.numeric(as.factor(country)))
m <- read_rds("Logistic_case_rate.rds")
```


Hvaða lönd eru notuð?

* Ef meri en 10 dagar eru síðan tíðni per 1000 fór yfir 0.01
* Ekki Kína í heild og heldur ekki Hubei

```{r}
d %>% 
    group_by(country) %>% 
    summarise(First = min(date),
              Days_In_Data = n(),
              Start_Rate = min(case_rate),
              End_Rate = max(case_rate)) %>% 
    kable %>% 
    kable_styling(bootstrap_options = c("striped", "hover"))
```


## Breytur

```{r}
N_obs <- nrow(d)
N_countries <- max(d$country_id)
max_case_rate <- 1000


days <- d$days
case_rate <- d$case_rate
country <- d$country_id %>% as.integer


pop <- d %>% distinct(country_id, pop) %>% .$pop / 1000

country_max <- d %>% 
    group_by(country_id) %>% 
    summarise(maximum = max(case_rate)) %>% 
    arrange(country_id) %>% 
    .$maximum


stan_data <- list(N_obs = N_obs, N_countries = N_countries, max_case_rate = max_case_rate,
                  days = days, case_rate = case_rate, country = country,
                  pop = pop, country_max = country_max)
```

```{r}
str(stan_data)
```



```{r, eval = F}
m <- sampling(stan_model("Logistic_case_rate_reverse.stan"), 
                  data  = stan_data, chains = 4, iter = 2000, warmup = 1000)
```

```{r, context = "render"}
selectInput(inputId = "country",
            label = "Land",
            choices = unique(d$country), selected = "Iceland")

plotOutput("pred_plot")
```


```{r, context = "server"}

output$pred_plot <- renderPlot({
    
    req(input$country)
    
    plot_dat <- d %>% filter(country == input$country)
    country_id = unique(plot_dat$country_id)
    chosen_country <- country_id
    results <- spread_draws(m, 
                            alpha[country_id],
                            beta[country_id], 
                            maximum[country_id]) %>% 
        filter(country_id == chosen_country) %>% 
        distinct(alpha, beta, maximum) %>% 
        mutate(iter = row_number()) %>% 
        expand_grid(days = seq(-10, 100)) %>% 
        mutate(linear = alpha + beta * days,
               rate = maximum / (1 + exp(-linear)))
    plot_lab <- str_c("Tíðni smita á höfðatölu í ", 
                      input$country, 
                      "Spá og raun")
    results %>% 
        mutate(date = days + min(plot_dat$date)) %>% 
        group_by(date) %>% 
        summarise(median = median(rate),
                  lower = quantile(rate, 0.025),
                  upper = quantile(rate, 0.975)) %>% 
        ggplot(aes(date, median, ymin = lower, ymax = upper)) +
        geom_line(aes(y = lower), lty = 2) +
        geom_line(aes(y = upper), lty = 2) +
        geom_line() +
        geom_point(data = plot_dat,
                   aes(date, case_rate), inherit.aes = F) +
        labs(y = "Forspáð tíðni smita (per 1000 íbúar)",
             title = plot_lab,
             subtitle = "Forspáð miðgildi ásamt 95% PI") +
        theme(axis.title.x = element_blank())
})
```

# Líkan (Stan kóði)

```{r, eval = FALSE}
data {
  int<lower = 0> N_obs;
  vector[N_obs] case_rate;
  vector[N_obs] days;
  int country[N_obs];
  int cases[N_obs];
  
  
  int<lower = 0> N_countries;
  vector[N_countries] pop;
  vector[N_countries] country_max;
  int<lower = 0> max_case_rate;
}

parameters {
  vector[N_countries] beta;
  vector[N_countries] alpha;
  vector<lower = 0, upper = 1>[N_countries] maximum_pre;
  
  real mu_beta;
  real<lower = 0> sigma_sq_beta;
  
  real mu_alpha;
  real<lower = 0> sigma_sq_alpha;
  
  vector<lower = 0>[N_countries] sigma_sq_obs;
  real<lower = 0> a_sigma_obs;
  real<lower = 0> b_sigma_obs;
  
  real<lower = 0> beta_a;
  real<lower = 0> beta_b;
}

transformed parameters {
  vector[N_countries] maximum = maximum_pre * max_case_rate;
  vector[N_obs] linear = alpha[country] + beta[country] .* days;
  vector<lower = 0, upper = 1000>[N_obs] true_rate;
  for (i in 1:N_obs) true_rate[i] = maximum[country[i]] .* 1 / (1 + exp(-linear[i]));
}

model {
  sigma_sq_beta ~ inv_chi_square(1);
  sigma_sq_alpha ~ inv_chi_square(1);
  sigma_sq_obs ~ inv_gamma(a_sigma_obs, b_sigma_obs);
  
  maximum_pre ~ beta(beta_a, beta_b);
  
  beta ~ normal(mu_beta, sigma_sq_beta);
  alpha ~ normal(mu_alpha, sigma_sq_alpha);
  
  
  case_rate ~ normal(true_rate, sigma_sq_obs[country]);
  
}
```

